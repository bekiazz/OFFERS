<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äì Elsewedy Electric</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="header-logo">
      <div class="company-name">ELSEWEDY</div>
      <div class="line"></div>
      <div class="slogan">ELECTRIC</div>
      <div class="accent-curve"></div>
    </div>
    <div>
      <button onclick="window.location.href='add-offer.html'">‚ûï Add Offer</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <main>
    <h2>Active Offers</h2>
    <div id="message" class="message"></div>
    <div id="offersGrid" class="offer-grid"></div>
  </main>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const grid = document.getElementById("offersGrid");
    const msg = document.getElementById("message");

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "login.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => window.location.href = "login.html");
    });

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadOffers() {
      try {
        const snap = await getDocs(collection(db, "offers"));
        grid.innerHTML = "";
        if (snap.empty) {
          grid.innerHTML = "<p>No offers found.</p>";
          return;
        }

        snap.forEach(doc => {
          const d = doc.data();
          const statusClass = d.status === "sent" ? "sent" : "pending";
          const value = d.value ? "$" + d.value.toLocaleString() : "N/A";
          const expiry = d.expiryDate?.toDate ? d.expiryDate.toDate() : d.expiryDate;
          const expiryStr = expiry ? new Date(expiry).toLocaleDateString() : "N/A";

          const card = document.createElement("div");
          card.className = "offer-card";
          card.innerHTML = `
            <h4>${escapeHtml(d.projectName)}</h4>
            <p><strong>Company:</strong> ${escapeHtml(d.company)}</p>
            <p><strong>Package:</strong> ${escapeHtml(d.customerPackageCode)}</p>
            <p><strong>Value:</strong> ${value}</p>
            <p><strong>Expiry:</strong> ${expiryStr}</p>
            <p><strong>Status:</strong> <span class="status ${statusClass}">${d.status}</span></p>
            <div class="offer-actions">
              <button class="btn" onclick="window.location.href='view-offer.html?id=${doc.id}'">üëÅÔ∏è View</button>
              ${d.status === "pending" ? 
                `<button class="btn" onclick="sendOffer('${doc.id}')">üì§ Send</button>` : 
                `<span>Sent: ${d.sentAt?.toDate?.().toLocaleDateString() || 'N/A'}</span>`}
            </div>
          `;
          grid.appendChild(card);
        });
      } catch (e) {
        msg.className = "message message-error";
        msg.textContent = "Failed to load offers: " + e.message;
      }
    }

    async function sendOffer(id) {
      if (!confirm("Mark this offer as SENT?")) return;
      try {
        const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js");
        await updateDoc(doc(db, "offers", id), {
          status: "sent",
          sentAt: new Date()
        });
        loadOffers();
      } catch (e) {
        alert("Error: " + e.message);
      }
    }

    window.sendOffer = sendOffer;
    loadOffers();
  </script>
</body>
</html>
