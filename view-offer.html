<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Offer Details – Elsewedy Electric</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="header-logo">
      <div class="company-name">ELSEWEDY</div>
      <div class="line"></div>
      <div class="slogan">ELECTRIC</div>
      <div class="accent-curve"></div>
    </div>
    <a href="dashboard.html" class="btn">← Back</a>
  </header>

  <main>
    <div class="container" id="offerDetails">
      <h2>Loading offer...</h2>
    </div>
  </main>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = 'login.html';
    });

    const urlParams = new URLSearchParams(window.location.search);
    const offerId = urlParams.get('id');
    const container = document.getElementById('offerDetails');

    if (!offerId) {
      container.innerHTML = "<p>❌ No offer ID provided.</p>";
      return;
    }

    async function loadOffer() {
      try {
        const docSnap = await getDoc(doc(db, "offers", offerId));
        if (!docSnap.exists()) {
          container.innerHTML = "<p>Offer not found.</p>";
          return;
        }

        const d = docSnap.data();
        const formatDate = (date) => date?.toDate?.() ? new Date(date.toDate()).toLocaleDateString() : 'N/A';
        const formatCurrency = (val) => val ? "$" + val.toLocaleString() : "N/A";

        container.innerHTML = `
          <h2>${d.projectName}</h2>
          <div class="form-row">
            <div class="form-group"><strong>Product:</strong> ${d.product}</div>
            <div class="form-group"><strong>Value:</strong> ${formatCurrency(d.value)}</div>
            <div class="form-group"><strong>Status:</strong> <span class="status ${d.status}">${d.status}</span></div>
          </div>

          <h3>Company & Contact</h3>
          <div class="form-row">
            <div class="form-group"><strong>Company:</strong> ${d.company}</div>
            <div class="form-group"><strong>Buyer:</strong> ${d.buyer}</div>
            <div class="form-group"><strong>Package Code:</strong> ${d.customerPackageCode}</div>
            <div class="form-group"><strong>Email:</strong> ${d.contacts.email}</div>
            <div class="form-group"><strong>Phone:</strong> ${d.contacts.phone || 'N/A'}</div>
          </div>

          <h3>Dates</h3>
          <div class="form-row">
            <div class="form-group"><strong>Start:</strong> ${formatDate(d.startDate)}</div>
            <div class="form-group"><strong>Expiry:</strong> ${formatDate(d.expiryDate)}</div>
            <div class="form-group"><strong>Delivery:</strong> ${formatDate(d.deliveryDate)}</div>
            ${d.status === 'sent' ? `<div class="form-group"><strong>Sent On:</strong> ${formatDate(d.sentAt)}</div>` : ''}
          </div>

          <h3>Additional Info</h3>
          <div class="form-group full-width"><strong>Factory:</strong> ${d.factory || 'N/A'}</div>
          <div class="form-group full-width"><strong>Probability:</strong> ${d.probability || 0}%</div>
          <div class="form-group full-width"><strong>Comment Status:</strong> ${d.commentStatus || 'N/A'}</div>
          <div class="form-group full-width"><strong>Comment:</strong> ${d.comment || '—'}</div>

          <h3>Description</h3>
          <div class="form-group full-width">${d.description.replace(/\n/g, '<br>')}</div>
        `;
      } catch (e) {
        container.innerHTML = `<p class="message message-error">Error: ${e.message}</p>`;
      }
    }

    loadOffer();
  </script>
</body>
</html>